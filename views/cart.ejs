<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Корзина</title>
</head>
<body>
    <h1>Корзина</h1>
    <ul>
        <% cartDetails.forEach(item => { %>
            <li>
                <% if (item.name && item.quantity !== undefined && item.totalCost !== undefined) { %>
                    <span id="product_<%= item.name %>">
                        <%= item.name %> - Количество: <%= item.quantity %> - Цена: <%= item.totalCost %> руб.
                    </span>
                <% } %>
                <% if (item.product && item.product.discountedPrice !== undefined && item.product.discountedPrice < item.product.price) { %>
                    (Со скидкой <%= item.product.discountedPrice %> руб. за единицу)
                <% } %>
            </li>
        <% }); %>
    </ul>
    <% if (cartDiscount > 0) { %>
        <p>Скидка: <%= cartDiscount %> руб.</p>
    <% } %>
    <p id="totalCost">Общая стоимость: <%= Math.max(cartTotal - cartDiscount, 0) %> руб.</p>
    <form id="applyPromoForm">
        <label for="promo_code">Промокод:</label>
        <input type="text" id="promo_code" name="promo_code" <% if (cartDiscount > 0) { %> disabled <% } %>>
        <button type="button" onclick="applyPromo()">Применить промокод</button>
    </form>
    <% if (errorMessage) { %>
        <script>
            alert('<%= errorMessage %>');
        </script>
    <% } %>
    <form action="/cart/checkout" method="post">
        <button type="submit">Купить</button>
    </form>

    <script>
        async function applyPromo() {
            const promoCodeInput = document.getElementById('promo_code');
            const promoCode = promoCodeInput.value;
    
            try {
                const response = await fetch('/cart/apply_promo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `promo_code=${encodeURIComponent(promoCode)}`,
                });
    
                const data = await response.json();
    
                if (data.success) {
                    document.getElementById('totalCost').innerText = 'Общая стоимость: ' + Math.max(data.cartTotal, 0) + ' руб.';
                    // Обновление цен после применения скидки
                    data.cartDetails.forEach(item => {
                        const productElement = document.getElementById('product_' + item.product.name);
                        if (productElement) {
                            productElement.innerHTML = `${item.product.name} - Количество: ${item.quantity} - Цена: ${item.totalCost} руб.`;
                        }
                    });
                    alert('Промокод применен успешно');
                } else {
                    alert('Ошибка при применении промокода: ' + data.errorMessage);
                }
            } catch (error) {
                console.error('Ошибка при применении промокода', error);
                alert('Ошибка при применении промокода');
            }
        }
    </script>
</body>
</html>
